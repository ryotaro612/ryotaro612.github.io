<!DOCTYPE html>
<html lang="en">

<head>
  
  
  <script>(function (w, d, s, l, i) {
      w[l] = w[l] || []; w[l].push({
        'gtm.start':
          new Date().getTime(), event: 'gtm.js'
      }); var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
          'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-W5TDG76');
  </script>
  
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=300,initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css"
    integrity="sha512-NmLkDIU1C/C88wi324HBc+S2kLhi08PN5GDeUVVVC/BVt/9Izdsc9SVeVfA1UZbY3sHUlDSyRXhCzHfr6hmPPw=="
    crossorigin="anonymous" />
  
  <link rel="stylesheet" href="https://ryotaro.dev/scss/base.min.d5f9c6d3a478082690f838fa06a179ccee4dea5bd3f0cb3f4a357e2803c48d33.css">
  
  <link rel="stylesheet" href="https://ryotaro.dev/scss/base.en.min.fabf7968ffbe5ff626ec9a346f0d38e91d0078974112f713b9d25782380a5073.css">
  

<link rel="stylesheet" href="https://ryotaro.dev/scss/single.min.8ed5cbfb3dc516e9c4459a65252e4e6e8e9026aabfa9eb9f602cf53b30754966.css">

<link rel="stylesheet" href="https://ryotaro.dev/scss/posts/single.min.0008713f3f7556e78c13cb8efde9cf534239cb206c10ba85ce5a76e6ae9ce758.css">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://kit.fontawesome.com/e48a1b5aa5.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
    integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
  
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
    integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4"
    crossorigin="anonymous"></script>
  
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
    integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>
  <title>OUTRAGEOUSLY LARGE NEURAL NETWORKS THE SPARSELY-GATED MIXTURE-OF-EXPERTS LAYER (2017)</title>
</head>

<body>
  
  
  <noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W5TDG76" height="0" width="0"
      style="display:none;visibility:hidden" />
  </noscript>
  
  
  <header class="navigation">
    <h2><a href="https://ryotaro.dev/en/">Blanket</a></h2>
    <nav>
      <ul>
        <li><a href="https://ryotaro.dev/en/about">About</a></li>
        <li><a href="https://ryotaro.dev/en/posts">Posts</a></li>
        <li><a href="https://ryotaro.dev/en/tags">Tags</a></li>
        
        <li><a href="https://ryotaro.dev/posts/outrageously-large-neural-networks-the-sparsely-gated-mixture-of-expert-layer/">ja</a></li>
        
      </ul>
      <ul>
        
        <li>
          <a href="https://github.com/ryotaro612">
            <i class="fab fa-github"></i>
          </a>
        </li>
        
        
        <li>
          <a href="https://www.linkedin.com/in/ryotaro612/">
            <i class="fab fa-linkedin-in"></i>
          </a>
        </li>
        
        
        <li>
          <a href="https://speakerdeck.com/ryotaro612/">
            <i class="fa-brands fa-speaker-deck"></i>
          </a>
        </li>
        
        <li>
          <a href="https://ryotaro.dev/en/%20index.xml">
            <i class="fas fa-rss"></i>
          </a>
        </li>
        
      </ul>
    </nav>
  </header>
  
<main>
  <h1>OUTRAGEOUSLY LARGE NEURAL NETWORKS THE SPARSELY-GATED MIXTURE-OF-EXPERTS LAYER (2017)</h1>
  <ul class="tags">
    
    <li class="tag">
      <a href="https://ryotaro.dev/en/tags/mixture-of-experts/">
        #Mixture-of-Experts
      </a>
    </li>
    
  </ul>
  <span class="date">
    
    August 1, 2025
    
  </span>
  <div>
    <p>Increasing a model’s number of parameters enhances its capacity to learn complex patterns, but it also raises computational costs.
<a href="https://arxiv.org/pdf/1701.06538">OUTRAGEOUSLY LARGE NEURAL NETWORKS: THE SPARSELY-GATED MIXTURE-OF-EXPERTS LAYER</a> (MoE)  introduces a method to scale model capacity efficiently by using a gating network that dynamically selects a sparse subset of feed-forward networks (called experts) for each input, while skipping computation for the others.</p>
<p>For a given input \(x\), let \(G(x)\) denote the output of the gating network, and \(E_i(x)\) represent the output of the \(i\)-th expert. The MoE layer produces its output (y) as a weighted sum of the selected experts’ outputs:
$$
y=\sum^n_{i=1}G(x)_iE_i(x)
$$
Here, \(G(x)\) is a sparse vector of size \(n\), where only \(k\) elements are positive (less than 1), and the rest are zero. Since the unselected experts contribute nothing to \(y\), only \(k\) experts need to be evaluated, which significantly reduces computation.</p>
<p>The gating network computes \(G(x)\) using two trainable parameters: \(W_g\), which determines expert selection, and \(W_{noise}\), which injects controlled noise to promote balanced usage of experts:
$$
\begin{align*}
G(x)&amp;=\text{Softmax}(\text{KeepTopK}(H(x), k))\\
H(x)_i&amp;=(x\cdot W_g)_i + \text{StandardNormal()}\cdot \text{Softplus}((x\cdot W_{\text{noise}})_i)\\
\text{KeepTopK}(v,k)_i&amp;=
\begin{cases}
v_i&amp;\text{if }v_i \text{ is in the top }k\text{ elements of }v\\
-\infty&amp;\text{otherwise}
\end{cases}
\end{align*}
$$</p>
<p>An imbalanced selection of experts leads to inefficient computation and underutilization of model capacity. To encourage balanced expert usage, two auxiliary loss terms are introduced: \(L_{\text{importance}}(X)\) and \(L_{\text{load}}(X)\).</p>
<p>The importance loss encourages equal contribution from all experts. Given a batch \(X\), the importance of each expert is the sum of its gate activations:
$$
\begin{align*}
\text{Importance}(X)&amp;=\sum_{x\in X}G(x)\\
L_{\text{importance}}(X)&amp;=w_{\text{importance}}\cdot \textit{CV}(\text{Importance}(X))^2
\end{align*}
$$
where \(\text{CV}\) denotes the coefficient of variation (standard deviation divided by mean), and \(w_{\text{importance}}\) is a hand-tuned scaling factor.</p>
<p>The load loss addresses the imbalance in the number of examples assigned to each expert. Since the number of examples is discrete and non-differentiable, a smooth estimator is used. For each expert \(i\), \(P(x, i)\) represents the probability that \(G(x)_i\) is non-zero, conditioned on the sampled noise:
$$
\begin{align*}
P(x, i) &amp;=\textit{Pr}\left((x\cdot W_g)_i + \text{StandardNormal}()\cdot \text{Softplus}((x\cdot W_{\text{noise}})_i) &gt; \text{kth\_excluding}(H(x), k, i)\right)\\
&amp;=\Phi\left(\frac{(x\cdot W_g)_i - \text{kth\_excluding}(H(x), k, i)}{\text{Softplus}((x\cdot W_{\text{noise}})_i)}\right)\\
\end{align*}
$$
where \(\Phi\) is the cumulative distribution function of the standard normal distribution, and \(\text{kth\_excluding}(v, k, i)\) denotes the \(k\)-th largest element of \(v\) excluding position \(i\).</p>
<p>The load for each expert across a batch \(X\) is then estimated as:
$$
\text{Load}(X)_i = \sum_{x\in X} P(x,i)
$$</p>
<p>The load loss is defined as:
$$
L_{\text{load}}(X)=w_{\text{load}}\cdot\text{CV}(\text{Load}(X))^2
$$
where \(w_{\text{load}}\) is another hand-tuned scaling factor.</p>
<p>By combining sparse gating with these load-balancing loss terms, the MoE layer achieves massive model capacity while keeping computation efficient.
This technique enables training models with billions of parameters without a corresponding increase in computational cost.</p>
  </div>
</main>

  
<ul class="pagination">
  
  <li>
    <a href="/en/posts/training-language-models-to-follow-instructions-with-human-feedback/">
      <i class="fa-solid fa-xl fa-angle-left"></i>
    </a>
  </li>
  
  
  <li>
    <a href="/en/posts/amazon.com-recommendations-item-to-item-collaborative-filtering/">
      <i class="fa-solid fa-xl fa-angle-right"></i>
    </a>
  </li>
  
</ul>


  <footer>
    <small>© Ryotaro Nakamura. All Rights Reserved.</small>
  </footer>
</body>


</html>
